<!DOCTYPE html>
<html lang='en'>
<head>
  <title>webgl</title>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
  <style>
  body {
    background-color: #000000;
    margin: 0px;
    overflow: hidden;
    font-family:Monospace;
    font-size:13px;
    text-align:center;
    font-weight: bold;
    text-align:center;
  }

  </style>
</head>
<body>
  <canvas id="canvas" width="500" height="500"></canvas>

  <script src='../src/program.js'></script>
  <script src='../src/databuffer.js'></script>
  <script src='../src/indexbuffer.js'></script>
  <script src='../src/rendertarget.js'></script>
  <script src='../src/texture.js'></script>
  <script src='../src/shaderlib.js'></script>
  <script src='../src/utils.js'></script>

  <script>
    var canvas = document.getElementById('canvas');
    var devicePixelRatio = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = canvas.style.height = '100%';
    var gl = canvas.getContext('webgl');
    Program.init(gl);

    var vertexShader = [
      'precision highp float;',
      'attribute vec2 coords;',
      'varying vec2 vCoords;',
      'void main() {',
      '  vCoords = coords;',
      '  gl_Position = vec4(coords * 2. - 1., 0.0, 1.0);',
      '}'
      ].join('\n');

    var fragmentShader = [
      'precision highp float;',
      'uniform float time;',
      'varying vec2 vCoords;',
      ShaderLib.noise3d,
      'float fn(vec3 coords) {',
      '  return snoise(coords * 2.);',
      '}',
      'void main() {',
      '  gl_FragColor = vec4(fn(vec3(vCoords, time)),',
      '    fn(vec3(vCoords.y, time, vCoords.x)),',
      '    fn(vec3(time, vCoords.x, vCoords.y)), 1.);',
      '}'
      ].join('\n');
    var size = 128;
    var coords = Utils.getTextureIndecies(size, size);

    var program = new Program(vertexShader, fragmentShader, {drawMode: gl.POINTS});
    program.addAttribute('coords', 2, gl.FLOAT, coords);
    
    program.addUniform('time', 'f', 0);

    var renderTarget = new RenderTarget(size, size, {type: gl.FLOAT});
    program.setRenderTarget(renderTarget, true)
    

    var vertexShader2 = [
      'precision highp float;',
      'uniform sampler2D dataTexture;',
      'attribute vec2 coords;',
      // 'attribute vec3 color;',
      // 'varying vec3 vData;',
      'varying vec3 vColor;',
      'void main() {',
      '  vec3 data = texture2D(dataTexture, coords).xyz;',
      // '  vData = data;',
      '  vColor = data;',
      '  gl_PointSize = 5.;',
      '  gl_Position = vec4(data, 1.);',
      '}'
      ].join('\n');

    var fragmentShader2 = [
      'precision highp float;',
      'varying vec3 vColor;',
      // 'varying vec3 vData;',
      'void main() {',
      '  gl_FragColor = vec4(vColor, 1.);',
      '}'
      ].join('\n');
      
    var program2 = new Program(vertexShader2, fragmentShader2, {
      drawMode: gl.POINTS,
      blendEnabled: true,
      depthTest: false
    });

    program2.addAttribute('coords', 2, gl.FLOAT, coords);
    
    program2.addUniform('dataTexture', 't', renderTarget.getGlTexture());
    program2.setViewport(
      window.innerWidth - window.innerHeight,
      0,
      window.innerHeight * devicePixelRatio,
      window.innerHeight * devicePixelRatio);

    var time = 0;
    function animate() {
      time += 0.0005;
      program.setUniform('time', time);
      program.draw(0, coords.numItems);
      program2.draw(0, coords.numItems);
      requestAnimationFrame(animate);
    }
    animate();
    
  </script>

</body>
</html>
