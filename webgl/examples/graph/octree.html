<!DOCTYPE html>
<html lang='en'>
<head>
  <title>webgl</title>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
  <style>
  body {
    background-color: #000000;
    margin: 0px;
    overflow: hidden;
    font-family:Monospace;
    font-size:13px;
    text-align:center;
    font-weight: bold;
    text-align:center;
  }

  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script src='../../src/program.js'></script>
  <script src='../../src/databuffer.js'></script>
  <script src='../../src/indexbuffer.js'></script>
  <script src='../../src/rendertarget.js'></script>
  <script src='../../src/texture.js'></script>
  <script src='../../src/shaderlib.js'></script>
  <script src='../../src/utils.js'></script>
  <script src='./octree.js'></script>

  <script>
    var canvas = document.getElementById('canvas');
    var devicePixelRatio = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = canvas.style.height = '100%';
    var gl = canvas.getContext('webgl');
    Program.init(gl);

    var vertexShader;
    var fragmentShader;
    var numVertices = 128 * 128;
    var size = Utils.getPotSize(numVertices);
    var program, program2, octreeProgram, mipmapTexture;
    var coords = Utils.getTextureIndecies(size.w, size.h, numVertices);
    var octree = new Octree();

    Utils.loadShaders([
      './update_posv.glsl',
      './update_posf.glsl',
      './draw_texturev.glsl',
      './draw_texturef.glsl',
      './populate_octreev.glsl',
      './populate_octreef.glsl'], function (shaders) {

      program = new Program(shaders[0], shaders[1], {drawMode: gl.POINTS});
      program.addAttribute('coords', 2, gl.FLOAT, coords);
      program.addUniform('time', 'f', 0);
      var positionTarget = new RenderTarget(size.w, size.h, {type: gl.FLOAT});
      program.setRenderTarget(positionTarget, true);

      octreeProgram = new Program(shaders[4], shaders[5], {
        drawMode: gl.POINTS,
        blendEnabled: true,
        depthTest: false,
        blendFunc: [gl.SRC_ALPHA, gl.ONE]
      });

      var sizeInfo = octree.getTextureSize(32);
      console.log('sizeInfo', sizeInfo)
      var octreeTarget = new RenderTarget(sizeInfo.width, sizeInfo.height, {type: gl.FLOAT});
      octreeProgram.addUniform('positionTexture', 't', positionTarget.getGlTexture());
      octreeProgram.addUniform('size', 'f', sizeInfo.size);
      octreeProgram.addUniform('slicesPerRow', 'f', sizeInfo.slicesPerRow);
      octreeProgram.addUniform('numRows', 'f', sizeInfo.numRows);
      octreeProgram.addAttribute('coords', 2, gl.FLOAT, coords);
      octreeProgram.setRenderTarget(octreeTarget, true);

      program2 = new Program(shaders[2], shaders[3], {
        // drawMode: gl.POINTS,
        drawMode: gl.LINE_STRIP,
        blendEnabled: true,
        depthTest: false
      });

      program2.addAttribute('coords', 2, gl.FLOAT, coords);
      program2.addUniform('positionTexture', 't', positionTarget.getGlTexture());
      program2.addUniform('octreeTexture', 't', octreeTarget.getGlTexture());
      program2.addUniform('lod', 'f');
      program2.addUniform('matrix', 'm4');
      program2.addUniform('size', 'f', sizeInfo.size);
      program2.addUniform('slicesPerRow', 'f', sizeInfo.slicesPerRow);
      program2.addUniform('numRows', 'f', sizeInfo.numRows);
      var sliceSize = [1 / sizeInfo.slicesPerRow, 1 / sizeInfo.numRows];
      program2.addUniform('sliceSize', 'v2', sliceSize);
      var slicePixelSize = [(sliceSize[0] / sizeInfo.size), (sliceSize[1] / sizeInfo.size)];
      program2.addUniform('slicePixelSize', 'v2', slicePixelSize);
      var sliceInnerSize = [slicePixelSize[0] * (sizeInfo.size - 1), slicePixelSize[1] * (sizeInfo.size - 1)];
      program2.addUniform('sliceInnerSize', 'v2', sliceInnerSize);

      mipmapTexture = new Texture(sizeInfo.width, sizeInfo.height, {
        type: gl.FLOAT,
        minFilter: gl.NEAREST_MIPMAP_NEAREST,
        magFilter: gl.NEAREST
      });

      mipmapTexture.glTexture = octreeTarget.getGlTexture();
      var ww = window.innerWidth * 2, wh = window.innerHeight * 2;
      var w = wh * 2, h = wh;
      program2.setViewport(
        0,
        0,
        ww, wh);

      animate();
    });


    var angle = 0, m = [];
    var rm = Matrix.makeYRotation(angle);
    var tm = Matrix.makeTranslation(0, 0, -5);
    var pm = Matrix.makePerspective(0.6, window.innerWidth / window.innerHeight, 0, 100);

    var time = -1;
    function animate() {
      time += 0.001;
      if (time > 1) time = -1;
      program.setUniform('time', angle);

      program.draw(0, coords.numItems);
      octreeProgram.draw(0, coords.numItems);
      var octTex = octreeProgram.renderTarget.texture;
      mipmapTexture.generateMipmap();
      mipmapTexture.applyParameters();

      Matrix.setYRotation(rm, angle += 0.005);
      Matrix.multiply(m, rm, tm, pm);

      program2.setUniform('matrix', m);

      program2.setUniform('lod', Math.floor(((time + 1) * 5) % 5));
      program2.draw(0, coords.numItems);

      octTex.applyParameters();
      requestAnimationFrame(animate);
    }

  </script>

</body>
</html>
