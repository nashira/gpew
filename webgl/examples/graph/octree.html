<!DOCTYPE html>
<html lang='en'>
<head>
  <title>webgl</title>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
  <style>
  body {
    background-color: #000000;
    margin: 0px;
    overflow: hidden;
    font-family:Monospace;
    font-size:13px;
    text-align:center;
    font-weight: bold;
    text-align:center;
  }

  </style>
</head>
<body>
  <canvas id="canvas"></canvas>

  <script src='../../src/program.js'></script>
  <script src='../../src/databuffer.js'></script>
  <script src='../../src/indexbuffer.js'></script>
  <script src='../../src/rendertarget.js'></script>
  <script src='../../src/texture.js'></script>
  <script src='../../src/shaderlib.js'></script>
  <script src='../../src/utils.js'></script>
  <script src='./octree.js'></script>

  <script>
    var canvas = document.getElementById('canvas');
    var devicePixelRatio = window.devicePixelRatio || 1;
    canvas.width = window.innerWidth * devicePixelRatio;
    canvas.height = window.innerHeight * devicePixelRatio;
    canvas.style.width = canvas.style.height = '100%';
    var gl = canvas.getContext('webgl');
    Program.init(gl);

    var vertexShader;
    var fragmentShader;
    var size = 64;
    var program, program2, octreeProgram, mipmapTexture;
    var coords = Utils.getTextureIndecies(size, size);
    var octree = new Octree();

    Utils.loadShaders([
      './update_posv.glsl',
      './update_posf.glsl',
      './draw_texturev.glsl',
      './draw_texturef.glsl',
      './populate_octreev.glsl',
      './populate_octreef.glsl'], function (shaders) {

      program = new Program(shaders[0], shaders[1], {drawMode: gl.POINTS});
      program.addAttribute('coords', 2, gl.FLOAT, coords);
      program.addUniform('time', 'f', 0);
      var positionTarget = new RenderTarget(size, size, {type: gl.FLOAT});
      program.setRenderTarget(positionTarget, true);

      octreeProgram = new Program(shaders[4], shaders[5], {
        drawMode: gl.POINTS,
        blendEnabled: true,
        depthTest: false,
        blendFunc: [gl.SRC_ALPHA, gl.ONE]
      });
      var sizeInfo = octree.getTextureSize(16);
      console.log('sizeInfo', sizeInfo)
      var octreeTarget = new RenderTarget(sizeInfo.width, sizeInfo.height, {type: gl.FLOAT});
      octreeProgram.addUniform('positionTexture', 't', positionTarget.getGlTexture());
      octreeProgram.addUniform('size', 'f', sizeInfo.size);
      octreeProgram.addUniform('slicesPerRow', 'f', sizeInfo.slicesPerRow);
      octreeProgram.addUniform('numRows', 'f', sizeInfo.numRows);
      octreeProgram.addAttribute('coords', 2, gl.FLOAT, coords);
      octreeProgram.setRenderTarget(octreeTarget, true);


      program2 = new Program(shaders[2], shaders[3], {drawMode: gl.POINTS});
      program2.addAttribute('coords', 2, gl.FLOAT, coords);
      program2.addUniform('lod', 'f')

      mipmapTexture = new Texture(sizeInfo.width, sizeInfo.height, {
        type: gl.FLOAT,
        minFilter: gl.NEAREST_MIPMAP_NEAREST,
        magFilter: gl.NEAREST
      });

      mipmapTexture.glTexture = octreeTarget.getGlTexture();

      program2.addUniform('tex', 't', octreeTarget.getGlTexture());
      var ww = window.innerWidth * 2, wh = window.innerHeight * 2;
      var w = wh * 1, h = wh;
      program2.setViewport(
        (ww - w) / 2,
        (wh - h) / 2,
        w, h);

      animate();
    });

    var time = -1;
    function animate() {
      time += 0.0001;
      if (time > 1) time = -1;
      program.setUniform('time', time);

      program.draw(0, coords.numItems);
      octreeProgram.draw(0, coords.numItems);
      var octTex = octreeProgram.renderTarget.texture;
      mipmapTexture.generateMipmap();
      mipmapTexture.applyParameters();

      program2.setUniform('lod', ((time + 1) * 20) % 3);
      program2.draw(0, coords.numItems);

      octTex.applyParameters();
      requestAnimationFrame(animate);
    }

  </script>

</body>
</html>
